{% extends 'food_donation/base.html' %}
{% load static %}

{% block title %}Test Map | Beyond Hunger{% endblock %}

{% block extra_css %}
<style>
    #map {
        height: 500px;
        width: 100%;
        margin-top: 20px;
        border-radius: 8px;
    }
    
    .info-box {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
    }
    
    .status {
        padding: 10px;
        margin-top: 10px;
        border-radius: 4px;
    }
    
    .status-success {
        background-color: #d4edda;
        color: #155724;
    }
    
    .status-error {
        background-color: #f8d7da;
        color: #721c24;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <h1 class="mb-3">Google Maps Test Page</h1>
    
    <div class="info-box">
        <h4>API Key Status</h4>
        <div id="api-status">Checking API key status...</div>
        <p class="mt-2">API Key: <code>{{ google_maps_api_key|truncatechars:12 }}...</code></p>
    </div>
    
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Test Map</h5>
            <div id="map"></div>
            <div class="mt-3">
                <button id="get-location" class="btn btn-primary">Get My Location</button>
                <button id="add-marker" class="btn btn-success">Add Test Marker</button>
                <button id="remove-markers" class="btn btn-danger">Remove All Markers</button>
            </div>
            <div id="location-status" class="status mt-3"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let map;
    let markers = [];
    
    // Initialize map
    function initMap() {
        try {
            // Create map centered on Mumbai, India
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 19.0760, lng: 77.8777 }, // Mumbai
                zoom: 10
            });
            
            // API loaded successfully
            const apiStatus = document.getElementById('api-status');
            apiStatus.classList.add('status', 'status-success');
            apiStatus.textContent = 'Google Maps API loaded successfully!';
            
            // Setup event listeners
            document.getElementById('get-location').addEventListener('click', getLocation);
            document.getElementById('add-marker').addEventListener('click', addTestMarker);
            document.getElementById('remove-markers').addEventListener('click', removeAllMarkers);
            
            // Add click listener to map
            map.addListener('click', function(event) {
                addMarker(event.latLng);
            });
        } catch (error) {
            // If there's an error loading the map
            const apiStatus = document.getElementById('api-status');
            apiStatus.classList.add('status', 'status-error');
            apiStatus.innerHTML = `Error loading Google Maps API: ${error.message}<br>Please check your API key.`;
        }
    }
    
    // Get user's location
    function getLocation() {
        const locationStatus = document.getElementById('location-status');
        locationStatus.textContent = 'Requesting location...';
        locationStatus.className = 'status';
        
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    // Center map on location
                    map.setCenter(userLocation);
                    map.setZoom(14);
                    
                    // Add marker at location
                    addMarker(userLocation, 'Your Location', true);
                    
                    // Update status
                    locationStatus.textContent = `Location found: ${position.coords.latitude.toFixed(6)}, ${position.coords.longitude.toFixed(6)}`;
                    locationStatus.className = 'status status-success';
                },
                function(error) {
                    let errorMessage = 'Error getting location: ';
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage += 'Location permission denied.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage += 'Location information unavailable.';
                            break;
                        case error.TIMEOUT:
                            errorMessage += 'Location request timed out.';
                            break;
                        default:
                            errorMessage += error.message;
                    }
                    
                    locationStatus.textContent = errorMessage;
                    locationStatus.className = 'status status-error';
                }
            );
        } else {
            locationStatus.textContent = 'Geolocation is not supported by this browser.';
            locationStatus.className = 'status status-error';
        }
    }
    
    // Add a test marker
    function addTestMarker() {
        const testLocation = { 
            lat: 19.0760 + (Math.random() - 0.5) * 0.1, 
            lng: 72.8777 + (Math.random() - 0.5) * 0.1 
        };
        addMarker(testLocation, 'Test Marker #' + (markers.length + 1));
    }
    
    // Add a marker to the map
    function addMarker(location, title = 'Marker', animate = false) {
        const marker = new google.maps.Marker({
            position: location,
            map: map,
            title: title,
            animation: animate ? google.maps.Animation.DROP : null,
            draggable: true
        });
        
        // Add info window
        const infoWindow = new google.maps.InfoWindow({
            content: `
                <div>
                    <h5>${title}</h5>
                    <p>Position: ${location.lat.toFixed(6)}, ${location.lng.toFixed(6)}</p>
                    <button onclick="removeMarker(${markers.length})" class="btn btn-sm btn-danger">Remove</button>
                </div>
            `
        });
        
        marker.addListener('click', function() {
            infoWindow.open(map, marker);
        });
        
        markers.push(marker);
        return marker;
    }
    
    // Remove all markers
    function removeAllMarkers() {
        for (let marker of markers) {
            marker.setMap(null);
        }
        markers = [];
    }
    
    // Remove a specific marker
    function removeMarker(index) {
        if (index >= 0 && index < markers.length) {
            markers[index].setMap(null);
            markers.splice(index, 1);
        }
    }
    
    // Handle Google Maps API load errors
    function handleMapError() {
        const apiStatus = document.getElementById('api-status');
        apiStatus.classList.add('status', 'status-error');
        apiStatus.innerHTML = 'Failed to load Google Maps API.<br>Please check your API key or network connection.';
        
        // Hide map container
        document.getElementById('map').innerHTML = '<div class="p-5 text-center text-muted">Map could not be loaded</div>';
    }
</script>
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places&callback=initMap" 
        async defer
        onerror="handleMapError()"></script>
{% endblock %} 